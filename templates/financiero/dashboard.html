{% extends "base.html" %}
{% load humanize %}

{% block title %}Dashboard Financiero - TransMaint{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
{% endblock %}

{% block content %}
<main class="space-y-6" role="main" aria-label="Dashboard financiero del contrato">
    <!-- Header with filters -->
    <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <div>
            <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Dashboard Financiero</h1>
            <p class="text-gray-600 dark:text-gray-400">Comparativo Presupuesto Planeado vs Real - {{ periodo_label }}</p>
        </div>
        <div class="flex flex-wrap gap-2 items-center" role="group" aria-label="Filtros">
            <!-- Year filter -->
            <div class="flex items-center gap-1">
                <label for="anio-filter" class="text-sm text-gray-600 dark:text-gray-400 font-medium">AÃ±o:</label>
                <select id="anio-filter"
                        class="rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-white text-sm"
                        onchange="applyFilters()">
                    {% for a in anios_disponibles %}
                    <option value="{{ a }}" {% if a == anio %}selected{% endif %}>{{ a }}</option>
                    {% endfor %}
                </select>
            </div>
            <!-- Month filter -->
            <div class="flex items-center gap-1">
                <label for="mes-filter" class="text-sm text-gray-600 dark:text-gray-400 font-medium">Mes:</label>
                <select id="mes-filter"
                        class="rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-white text-sm"
                        onchange="applyFilters()">
                    {% for m in meses_opciones %}
                    <option value="{{ m.value }}" {% if m.value == mes %}selected{% endif %}>{{ m.label }}</option>
                    {% endfor %}
                </select>
            </div>
            <!-- Quick links to detailed views -->
            <a href="{% url 'financiero:presupuesto_planeado' %}?anio={{ anio }}"
               class="px-3 py-2 text-sm bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300 rounded-lg hover:bg-blue-200 dark:hover:bg-blue-900/50 transition font-medium">
                Ver Planeado
            </a>
            <a href="{% url 'financiero:presupuesto_real' %}?anio={{ anio }}"
               class="px-3 py-2 text-sm bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300 rounded-lg hover:bg-green-200 dark:hover:bg-green-900/50 transition font-medium">
                Ver Real
            </a>
        </div>
    </header>

    <div id="dashboard-content" aria-live="polite">
        <!-- Budget Alerts -->
        {% if alertas %}
        <section class="mb-6 space-y-3">
            {% for alerta in alertas %}
            <div class="flex items-center gap-3 p-4 rounded-lg
                {% if alerta.color == 'red' %}bg-red-50 border border-red-200 dark:bg-red-900/20 dark:border-red-800
                {% elif alerta.color == 'yellow' %}bg-yellow-50 border border-yellow-200 dark:bg-yellow-900/20 dark:border-yellow-800
                {% else %}bg-green-50 border border-green-200 dark:bg-green-900/20 dark:border-green-800{% endif %}"
                role="alert">
                <div class="flex-shrink-0">
                    {% if alerta.color == 'red' %}
                    <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.34 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                    </svg>
                    {% else %}
                    <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    {% endif %}
                </div>
                <div>
                    <h3 class="font-semibold {% if alerta.color == 'red' %}text-red-800 dark:text-red-300{% else %}text-yellow-800 dark:text-yellow-300{% endif %}">
                        {{ alerta.titulo }}
                    </h3>
                    <p class="text-sm {% if alerta.color == 'red' %}text-red-700 dark:text-red-400{% else %}text-yellow-700 dark:text-yellow-400{% endif %}">
                        {{ alerta.mensaje }}
                    </p>
                </div>
            </div>
            {% endfor %}
        </section>
        {% endif %}

        <!-- Summary KPIs: Planeado vs Real -->
        <section class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <!-- Ingreso -->
            <article class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
                <h3 class="text-sm text-gray-500 dark:text-gray-400 mb-3 font-medium uppercase tracking-wide">Ingreso Proyectado</h3>
                <div class="grid grid-cols-3 gap-3 text-center">
                    <div class="min-w-0">
                        <p class="text-xs text-blue-600 font-medium">Planeado</p>
                        <p class="text-sm font-bold text-gray-900 dark:text-white truncate">${{ resumen_planeado.ingreso|floatformat:0|intcomma }}</p>
                    </div>
                    <div class="min-w-0">
                        <p class="text-xs text-green-600 font-medium">Real</p>
                        <p class="text-sm font-bold text-gray-900 dark:text-white truncate">${{ resumen_real.ingreso|floatformat:0|intcomma }}</p>
                    </div>
                    <div class="min-w-0">
                        <p class="text-xs text-gray-500 font-medium">Diferencia</p>
                        <p class="text-sm font-bold truncate {% if diff_ingreso >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                            ${{ diff_ingreso|floatformat:0|intcomma }}
                        </p>
                    </div>
                </div>
            </article>

            <!-- Total Gastos -->
            <article class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
                <h3 class="text-sm text-gray-500 dark:text-gray-400 mb-3 font-medium uppercase tracking-wide">Total Gastos</h3>
                <div class="grid grid-cols-3 gap-3 text-center">
                    <div class="min-w-0">
                        <p class="text-xs text-blue-600 font-medium">Planeado</p>
                        <p class="text-sm font-bold text-gray-900 dark:text-white truncate">${{ resumen_planeado.total_gastos|floatformat:0|intcomma }}</p>
                    </div>
                    <div class="min-w-0">
                        <p class="text-xs text-green-600 font-medium">Real</p>
                        <p class="text-sm font-bold text-gray-900 dark:text-white truncate">${{ resumen_real.total_gastos|floatformat:0|intcomma }}</p>
                    </div>
                    <div class="min-w-0">
                        <p class="text-xs text-gray-500 font-medium">Diferencia</p>
                        <p class="text-sm font-bold truncate {% if diff_gastos <= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                            ${{ diff_gastos|floatformat:0|intcomma }}
                        </p>
                    </div>
                </div>
            </article>

            <!-- Resultado -->
            <article class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
                <h3 class="text-sm text-gray-500 dark:text-gray-400 mb-3 font-medium uppercase tracking-wide">Resultado (Ingreso - Gastos)</h3>
                <div class="grid grid-cols-3 gap-3 text-center">
                    <div class="min-w-0">
                        <p class="text-xs text-blue-600 font-medium">Planeado</p>
                        <p class="text-sm font-bold truncate {% if resumen_planeado.resultado >= 0 %}text-green-700{% else %}text-red-600{% endif %}">
                            ${{ resumen_planeado.resultado|floatformat:0|intcomma }}
                        </p>
                    </div>
                    <div class="min-w-0">
                        <p class="text-xs text-green-600 font-medium">Real</p>
                        <p class="text-sm font-bold truncate {% if resumen_real.resultado >= 0 %}text-green-700{% else %}text-red-600{% endif %}">
                            ${{ resumen_real.resultado|floatformat:0|intcomma }}
                        </p>
                    </div>
                    <div class="min-w-0">
                        <p class="text-xs text-gray-500 font-medium">Diferencia</p>
                        <p class="text-sm font-bold truncate {% if diff_resultado >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                            ${{ diff_resultado|floatformat:0|intcomma }}
                        </p>
                    </div>
                </div>
            </article>
        </section>

        <!-- Secondary KPIs row -->
        <section class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <article class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
                <p class="text-xs text-gray-500 dark:text-gray-400">Costos Variables (Planeado)</p>
                <p class="text-xl font-bold text-blue-600">${{ resumen_planeado.total_variables|floatformat:0|intcomma }}</p>
            </article>
            <article class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
                <p class="text-xs text-gray-500 dark:text-gray-400">Costos Variables (Real)</p>
                <p class="text-xl font-bold text-green-600">${{ resumen_real.total_variables|floatformat:0|intcomma }}</p>
            </article>
            <article class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
                <p class="text-xs text-gray-500 dark:text-gray-400">Costos Fijos (Planeado)</p>
                <p class="text-xl font-bold text-blue-600">${{ resumen_planeado.total_fijos|floatformat:0|intcomma }}</p>
            </article>
            <article class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
                <p class="text-xs text-gray-500 dark:text-gray-400">Costos Fijos (Real)</p>
                <p class="text-xl font-bold text-green-600">${{ resumen_real.total_fijos|floatformat:0|intcomma }}</p>
            </article>
        </section>

        <!-- Utility comparison -->
        <section class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
            <article class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">% Utilidad Planeada</h3>
                <div class="flex items-center gap-4">
                    <div class="flex-1">
                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-4">
                            <div class="h-4 rounded-full transition-all duration-700 {% if resumen_planeado.utilidad_pct >= 0 %}bg-blue-500{% else %}bg-red-500{% endif %}"
                                style="width: min({{ resumen_planeado.utilidad_pct|floatformat:0 }}%, 100%)"></div>
                        </div>
                    </div>
                    <span class="text-2xl font-bold {% if resumen_planeado.utilidad_pct >= 0 %}text-blue-600{% else %}text-red-600{% endif %}">
                        {{ resumen_planeado.utilidad_pct|floatformat:1 }}%
                    </span>
                </div>
            </article>

            <article class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">% Utilidad Real</h3>
                <div class="flex items-center gap-4">
                    <div class="flex-1">
                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-4">
                            <div class="h-4 rounded-full transition-all duration-700 {% if resumen_real.utilidad_pct >= 0 %}bg-green-500{% else %}bg-red-500{% endif %}"
                                style="width: min({{ resumen_real.utilidad_pct|floatformat:0 }}%, 100%)"></div>
                        </div>
                    </div>
                    <span class="text-2xl font-bold {% if resumen_real.utilidad_pct >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                        {{ resumen_real.utilidad_pct|floatformat:1 }}%
                    </span>
                </div>
            </article>
        </section>

        <!-- Charts Row -->
        <section class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- Gastos Mensual: Planeado vs Real -->
            <article class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Gastos Mensuales: Planeado vs Real</h3>
                <div id="chart-gastos-mensual" class="h-80"></div>
            </article>

            <!-- Ingreso Mensual: Planeado vs Real -->
            <article class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Ingreso Mensual: Planeado vs Real</h3>
                <div id="chart-ingreso-mensual" class="h-80"></div>
            </article>
        </section>

        <!-- Costos por Categoria: Planeado vs Real -->
        <section class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-6">
            <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Costos por Categoria: Planeado vs Real</h3>
            <div id="chart-categoria-comparacion" class="h-96"></div>
        </section>

        <!-- Detalle Comparativo -->
        <section class="bg-white dark:bg-gray-800 rounded-lg shadow overflow-hidden">
            <div class="p-4 border-b dark:border-gray-700">
                <h3 class="font-medium text-gray-900 dark:text-white">Detalle Comparativo: Planeado vs Real</h3>
                <p class="text-sm text-gray-500 dark:text-gray-400">{{ periodo_label }}</p>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                    <thead class="bg-gray-50 dark:bg-gray-900">
                        <tr>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Categoria</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tipo</th>
                            <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-blue-600 uppercase">Planeado</th>
                            <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-green-600 uppercase">Real</th>
                            <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Diferencia</th>
                            <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">% Desviacion</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                        {% for item in detalle_comparacion %}
                        <tr class="hover:bg-gray-50 dark:hover:bg-gray-700
                            {% if item.seccion == 'Ingreso' %}bg-green-50/50 dark:bg-green-900/10{% endif %}">
                            <td class="px-4 py-3 text-sm font-medium text-gray-900 dark:text-white">{{ item.categoria }}</td>
                            <td class="px-4 py-3 text-sm">
                                <span class="px-2 py-0.5 rounded text-xs font-medium
                                    {% if item.seccion == 'Ingreso' %}bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300
                                    {% elif item.seccion == 'Variable' %}bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300
                                    {% else %}bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-300{% endif %}">
                                    {{ item.seccion }}
                                </span>
                            </td>
                            <td class="px-4 py-3 text-sm text-right text-blue-700 dark:text-blue-400">${{ item.planeado|floatformat:0|intcomma }}</td>
                            <td class="px-4 py-3 text-sm text-right text-green-700 dark:text-green-400 font-medium">${{ item.real|floatformat:0|intcomma }}</td>
                            <td class="px-4 py-3 text-sm text-right font-medium
                                {% if item.seccion == 'Ingreso' %}
                                    {% if item.diferencia >= 0 %}text-green-600{% else %}text-red-600{% endif %}
                                {% else %}
                                    {% if item.diferencia <= 0 %}text-green-600{% else %}text-red-600{% endif %}
                                {% endif %}">
                                ${{ item.diferencia|floatformat:0|intcomma }}
                            </td>
                            <td class="px-4 py-3 text-sm text-right">
                                {% if item.pct_desviacion != 0 %}
                                <span class="{% if item.seccion == 'Ingreso' %}
                                        {% if item.pct_desviacion >= 0 %}text-green-600{% else %}text-red-600{% endif %}
                                    {% else %}
                                        {% if item.pct_desviacion <= 0 %}text-green-600{% else %}text-red-600{% endif %}
                                    {% endif %}">
                                    {{ item.pct_desviacion|floatformat:1 }}%
                                </span>
                                {% else %}
                                <span class="text-gray-400">-</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot class="bg-gray-100 dark:bg-gray-900 font-bold">
                        <tr>
                            <td colspan="2" class="px-4 py-3 text-sm">TOTAL GASTOS</td>
                            <td class="px-4 py-3 text-sm text-right text-blue-700">${{ resumen_planeado.total_gastos|floatformat:0|intcomma }}</td>
                            <td class="px-4 py-3 text-sm text-right text-green-700">${{ resumen_real.total_gastos|floatformat:0|intcomma }}</td>
                            <td class="px-4 py-3 text-sm text-right {% if diff_gastos <= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                                ${{ diff_gastos|floatformat:0|intcomma }}
                            </td>
                            <td class="px-4 py-3 text-sm text-right">
                                {% if resumen_planeado.total_gastos %}
                                {% widthratio diff_gastos resumen_planeado.total_gastos 100 as pct_total %}
                                {% endif %}
                            </td>
                        </tr>
                        <tr class="bg-yellow-50 dark:bg-yellow-900/20">
                            <td colspan="2" class="px-4 py-3 text-sm">RESULTADO</td>
                            <td class="px-4 py-3 text-sm text-right {% if resumen_planeado.resultado >= 0 %}text-green-700{% else %}text-red-600{% endif %}">
                                ${{ resumen_planeado.resultado|floatformat:0|intcomma }}
                            </td>
                            <td class="px-4 py-3 text-sm text-right {% if resumen_real.resultado >= 0 %}text-green-700{% else %}text-red-600{% endif %}">
                                ${{ resumen_real.resultado|floatformat:0|intcomma }}
                            </td>
                            <td class="px-4 py-3 text-sm text-right {% if diff_resultado >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                                ${{ diff_resultado|floatformat:0|intcomma }}
                            </td>
                            <td class="px-4 py-3 text-sm text-right"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </section>
    </div>
</main>
{% endblock %}

{% block extra_js %}
<script>
function applyFilters() {
    const anio = document.getElementById('anio-filter').value;
    const mes = document.getElementById('mes-filter').value;
    window.location.href = '{% url "financiero:dashboard" %}?anio=' + anio + '&mes=' + mes;
}

document.addEventListener('DOMContentLoaded', function() {
    const formatter = function(value) {
        if (value >= 1000000) return '$' + (value / 1000000).toFixed(1) + 'M';
        if (value >= 1000) return '$' + (value / 1000).toFixed(0) + 'K';
        return '$' + value;
    };

    // Gastos Mensual: Planeado vs Real (Line)
    const chartGastos = echarts.init(document.getElementById('chart-gastos-mensual'));
    chartGastos.setOption({
        tooltip: { trigger: 'axis', valueFormatter: v => '$' + v.toLocaleString('es-CO') },
        legend: { data: ['Planeado', 'Real'], bottom: 0 },
        xAxis: { type: 'category', data: {{ meses_labels|safe }} },
        yAxis: { type: 'value', axisLabel: { formatter: formatter } },
        series: [
            {
                name: 'Planeado',
                type: 'line',
                data: {{ planeado_mensual|safe }},
                lineStyle: { type: 'dashed', width: 2 },
                itemStyle: { color: '#3b82f6' },
                symbol: 'circle',
                symbolSize: 6
            },
            {
                name: 'Real',
                type: 'line',
                data: {{ real_mensual|safe }},
                itemStyle: { color: '#10b981' },
                areaStyle: { color: 'rgba(16, 185, 129, 0.1)' },
                symbol: 'circle',
                symbolSize: 6
            }
        ],
        grid: { left: '3%', right: '4%', bottom: '15%', containLabel: true }
    });

    // Ingreso Mensual: Planeado vs Real (Line)
    const chartIngreso = echarts.init(document.getElementById('chart-ingreso-mensual'));
    chartIngreso.setOption({
        tooltip: { trigger: 'axis', valueFormatter: v => '$' + v.toLocaleString('es-CO') },
        legend: { data: ['Planeado', 'Real'], bottom: 0 },
        xAxis: { type: 'category', data: {{ meses_labels|safe }} },
        yAxis: { type: 'value', axisLabel: { formatter: formatter } },
        series: [
            {
                name: 'Planeado',
                type: 'line',
                data: {{ ingreso_planeado_mensual|safe }},
                lineStyle: { type: 'dashed', width: 2 },
                itemStyle: { color: '#3b82f6' },
                symbol: 'circle',
                symbolSize: 6
            },
            {
                name: 'Real',
                type: 'line',
                data: {{ ingreso_real_mensual|safe }},
                itemStyle: { color: '#10b981' },
                areaStyle: { color: 'rgba(16, 185, 129, 0.1)' },
                symbol: 'circle',
                symbolSize: 6
            }
        ],
        grid: { left: '3%', right: '4%', bottom: '15%', containLabel: true }
    });

    // Costos por Categoria: Planeado vs Real (Grouped Bar)
    const chartCategoria = echarts.init(document.getElementById('chart-categoria-comparacion'));
    chartCategoria.setOption({
        tooltip: { trigger: 'axis', valueFormatter: v => '$' + v.toLocaleString('es-CO') },
        legend: { data: ['Planeado', 'Real'], bottom: 0 },
        xAxis: {
            type: 'category',
            data: {{ cat_labels|safe }},
            axisLabel: { rotate: 30, fontSize: 10 }
        },
        yAxis: { type: 'value', axisLabel: { formatter: formatter } },
        series: [
            {
                name: 'Planeado',
                type: 'bar',
                data: {{ cat_planeado|safe }},
                itemStyle: { color: '#3b82f6' },
                barMaxWidth: 40
            },
            {
                name: 'Real',
                type: 'bar',
                data: {{ cat_real|safe }},
                itemStyle: { color: '#10b981' },
                barMaxWidth: 40
            }
        ],
        grid: { left: '3%', right: '4%', bottom: '20%', containLabel: true }
    });

    // Resize
    window.addEventListener('resize', function() {
        chartGastos.resize();
        chartIngreso.resize();
        chartCategoria.resize();
    });
});
</script>
{% endblock %}
